name: Build and Deploy Application

on:
  push:
    branches: [main]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Configure Java
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Build project
        run: mvn clean package -DskipTests

      - name: Get JAR info
        id: jar
        run: |
          JAR_FILE=$(ls target/*.jar | head -n 1)
          JAR_SIZE=$(stat -c%s "$JAR_FILE")
          echo "file=$JAR_FILE" >> $GITHUB_OUTPUT
          echo "name=$(basename $JAR_FILE)" >> $GITHUB_OUTPUT
          echo "size=$JAR_SIZE" >> $GITHUB_OUTPUT
          echo "ğŸ“¦ JAR construÃ­do: $(basename $JAR_FILE)"
          echo "ğŸ“Š Tamanho: $(numfmt --to=iec-i --suffix=B $JAR_SIZE)"

      - name: Setup SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H ${{ secrets.EC2_HOST }} >> ~/.ssh/known_hosts 2>/dev/null || true

      - name: Transfer JAR to EC2
        run: |
          echo "ğŸ“¤ Transferindo JAR para EC2..."
          cat ${{ steps.jar.outputs.file }} | \
          ssh -i ~/.ssh/deploy_key \
            -o StrictHostKeyChecking=no \
            -o ConnectTimeout=60 \
            ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} \
            "cat > /home/ec2-user/event-api/event-api.new.jar"
          
          echo "âœ… TransferÃªncia concluÃ­da!"

      - name: Deploy and Restart Service
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          port: 22
          timeout: 90s
          command_timeout: 10m
          script: |
            set -e
            
            cd /home/ec2-user/event-api
            
            echo "ğŸ“‹ Verificando arquivo recebido..."
            if [ ! -f event-api.new.jar ]; then
              echo "âŒ Arquivo nÃ£o encontrado!"
              exit 1
            fi
            
            FILE_SIZE=$(stat -c%s event-api.new.jar)
            echo "âœ… Arquivo recebido: $(numfmt --to=iec-i --suffix=B $FILE_SIZE)"
            
            # Backup do JAR antigo
            if [ -f event-api.jar ]; then
              echo "ğŸ’¾ Fazendo backup do JAR anterior..."
              BACKUP_NAME="event-api.jar.backup.$(date +%Y%m%d_%H%M%S)"
              cp event-api.jar "$BACKUP_NAME"
              echo "âœ… Backup criado: $BACKUP_NAME"
            
              # Manter apenas os 5 backups mais recentes
              ls -t event-api.jar.backup.* 2>/dev/null | tail -n +6 | xargs -r rm
            fi
            
            # Substituir pelo novo JAR
            echo "ğŸ”„ Substituindo JAR..."
            mv event-api.new.jar event-api.jar
            chmod +x event-api.jar
            
            # Verificar se o serviÃ§o existe
            if ! systemctl list-unit-files | grep -q event-api.service; then
              echo "âš ï¸  ServiÃ§o event-api nÃ£o encontrado!"
              echo "ğŸ“ Criando serviÃ§o..."
            
              sudo tee /etc/systemd/system/event-api.service > /dev/null <<EOF
            [Unit]
            Description=Event API Application
            After=network.target
            
            [Service]
            Type=simple
            User=ec2-user
            WorkingDirectory=/home/ec2-user/event-api
            ExecStart=/usr/bin/java -jar /home/ec2-user/event-api/event-api.jar
            Restart=on-failure
            RestartSec=10
            StandardOutput=append:/home/ec2-user/event-api/logs/application.log
            StandardError=append:/home/ec2-user/event-api/logs/error.log
            
            [Install]
            WantedBy=multi-user.target
            EOF
            
              sudo systemctl daemon-reload
              sudo systemctl enable event-api
              echo "âœ… ServiÃ§o criado e habilitado"
            fi
            
            # Criar diretÃ³rio de logs se nÃ£o existir
            mkdir -p /home/ec2-user/event-api/logs
            
            echo "ğŸ”„ Reiniciando serviÃ§o..."
            sudo systemctl restart event-api
            
            echo "â³ Aguardando serviÃ§o iniciar..."
            sleep 10
            
            # Verificar status
            if sudo systemctl is-active --quiet event-api; then
              echo ""
              echo "=========================================="
              echo "âœ… DEPLOY REALIZADO COM SUCESSO!"
              echo "=========================================="
              echo ""
              echo "ğŸ“Š Status do serviÃ§o:"
              sudo systemctl status event-api --no-pager -l | head -n 20
              echo ""
              echo "ğŸ“ Ãšltimas linhas do log (se disponÃ­vel):"
              tail -n 10 /home/ec2-user/event-api/logs/application.log 2>/dev/null || echo "Logs ainda nÃ£o disponÃ­veis"
              echo ""
              echo "=========================================="
            else
              echo ""
              echo "=========================================="
              echo "âŒ ERRO AO INICIAR O SERVIÃ‡O"
              echo "=========================================="
              echo ""
              echo "ğŸ“Š Status do serviÃ§o:"
              sudo systemctl status event-api --no-pager -l
              echo ""
              echo "ğŸ“ Logs de erro do systemd:"
              sudo journalctl -u event-api -n 50 --no-pager
              echo ""
              echo "ğŸ“ Logs de erro da aplicaÃ§Ã£o:"
              tail -n 30 /home/ec2-user/event-api/logs/error.log 2>/dev/null || echo "Sem logs de erro"
              echo ""
            
              # Tentar restaurar backup
              LATEST_BACKUP=$(ls -t event-api.jar.backup.* 2>/dev/null | head -n 1)
              if [ -n "$LATEST_BACKUP" ]; then
                echo "ğŸ”™ Tentando restaurar backup: $LATEST_BACKUP"
                cp "$LATEST_BACKUP" event-api.jar
                sudo systemctl restart event-api
                sleep 5
            
                if sudo systemctl is-active --quiet event-api; then
                  echo "âœ… Backup restaurado com sucesso"
                else
                  echo "âŒ Falha ao restaurar backup"
                fi
              fi
            
              exit 1
            fi