name: Deploy Event API (Self-hosted)
on:
  push:
    branches: [main]
jobs:
  deploy:
    runs-on: [self-hosted, event-api]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Build application
        run: |
          mvn clean package -DskipTests

      - name: Deploy application
        run: |
          set -e
          APP_DIR=/opt/event-api
          JAR_NAME=event-api.jar
          NEW_JAR=$(ls target/*jar | grep -v original | head -n 1)

          echo "ğŸ›‘ Parando serviÃ§o"
          sudo systemctl stop event-api || true

          echo "ğŸ“¦ Backup do JAR atual"
          if [ -f "$APP_DIR/$JAR_NAME" ]; then
            cp "$APP_DIR/$JAR_NAME" "$APP_DIR/$JAR_NAME.bak"
          fi

          echo "ğŸš€ Copiando novo JAR: $NEW_JAR"
          cp "$NEW_JAR" "$APP_DIR/$JAR_NAME"

          echo "â–¶ï¸ Iniciando serviÃ§o"
          sudo systemctl start event-api

          echo "ğŸ“Š Status final"
          sudo systemctl status event-api --no-pager
