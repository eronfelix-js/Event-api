name: Deploy Event API (Self-hosted)

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: self-hosted

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Build JAR
        run: mvn clean package -DskipTests

      - name: Deploy
        run: |
          set -e

          echo "ğŸ›‘ Parando serviÃ§o"
          sudo systemctl stop event-api || true

          echo "ğŸ“¦ Backup"
          if [ -f /opt/event-api/event-api.jar ]; then
            cp /opt/event-api/event-api.jar /opt/event-api/event-api.jar.bak
          fi

          echo "ğŸš€ Atualizando JAR"
          cp target/*.jar /opt/event-api/event-api.jar

          echo "â–¶ï¸ Iniciando serviÃ§o"
          sudo systemctl start event-api

          echo "ğŸ“Š Status"
          sudo systemctl status event-api --no-pager
